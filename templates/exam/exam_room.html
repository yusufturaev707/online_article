{% extends 'exam/base.html' %}
{% load static %}
{% block title %}Onlayn imtihon{% endblock %}
{% block content %}
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fa fa-user" aria-hidden="true"></i> {{ fio }}</a>
            <h3 style="font-family: Cambria,fantasy">{{ subject }}</h3>

            <div class="row">
                {% if not is_finished %}
                    <h4 class="viewArticleFont">
                        <img src="{% static 'img/timer.png' %}" alt="Time"/> &nbsp;<span id="demo">00:00:00</span>
                    </h4>
                {% endif %}
            </div>

            {% if not is_finished %}
                <button type="button" class="btn btn-outline-danger" id="finishBtn"><i
                        class="fa fa-flag-checkered" aria-hidden="true"></i> Yakunlash
                </button>
            {% endif %}
        </div>
    </nav>
    <br>
    <div class="container" style="font-family: Arial,serif;">
        {% if not is_finished %}
            <div class="container">
                <div class="pagination p3 justify-content-center">
                    <nav>
                        <ul id="questionBtnUl">

                        </ul>
                    </nav>
                </div>
            </div>
            <div class="row"><p class="questionNumber viewArticleFont" style="font-size: large"></p></div>
            <div class="row justify-content-center">
                <div class="col justify-content-center forshadow" style="height: 500px; overflow-y:scroll;border: 1px solid #d3d1d1; background-color: #FFFFFF; border-radius: 5px">
                    <canvas id="pdf-example"></canvas>
                </div>
            </div>
            <div class="row">
             <div class="col justify-content-center">
                    <form method="post" id="nextQuestionForm" data-url="{% url 'next_question' %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col">
                                <center>
                                    <label>
                                        <input type="number" hidden="hidden" name="question_id"
                                               class="question_id_field"/>
                                    </label>
                                    <ul style="font-size: 50px;">
                                        <li>
                                            <label class="btn btn-outline-success btn-lg Answer forshadow" id="answerA"><strong>A</strong>
                                                <input type="radio" class="btn-check" name="test" value="0"
                                                       autocomplete="off" id="radioA" style="display: none">
                                            </label>
                                        </li>
                                        <li>
                                            <label class="btn btn-outline-success btn-lg Answer forshadow" id="answerB"><strong>B</strong>
                                                <input type="radio" class="btn-check" name="test" value="1"
                                                       autocomplete="off" id="radioB" style="display: none">
                                            </label>
                                        </li>
                                        <li>
                                            <label class="btn btn-outline-success btn-lg Answer forshadow" id="answerC"><strong>C</strong>
                                                <input type="radio" class="btn-check" name="test" value="2"
                                                       autocomplete="off" id="radioC" style="display: none">
                                            </label>
                                        </li>
                                        <li>
                                            <label class="btn btn-outline-success btn-lg Answer forshadow" id="answerD"><strong>D</strong>
                                                <input type="radio" class="btn-check" name="test" value="3"
                                                       autocomplete="off" id="radioD" style="display: none">
                                            </label>
                                        </li>
                                    </ul>
                                </center>
                            </div>
                        </div>
                        <div class="row">
                            <a class="btn btn-warning btn-block forshadow appealBtn" style="margin-bottom: 10px;"><span> Savolga e'tirozim mavjud</span></a>
                            <button type="submit" class="btn btn-block btn-light-green nextQuestionBtn forshadow">Keyingisi <i
                                    class="fa fa-angle-double-right" aria-hidden="true"></i></button>
                        </div>
                        <br>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="container" style="padding-top: 10%">
                <div class="row justify-content-center">
                    <h1 class="viewArticleFont text-center text-danger">Test sinovi yakunlandi</h1>
                    <br>
                    <br>
                    <br>
                    <button id="viewResultTest" class="btn btn-primary btn-block" style="font-size: large"><img
                            src="{% static 'img/resulttest.png' %}" alt="Rasm topilmadi"> &nbsp;&nbsp;&nbsp;Natijani ko'rish
                    </button>
                </div>
            </div>
        {% endif %}
    <div id="resultDiv"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {

            $("#viewResultTest").click(function () {
                $.ajax({
                    url: "{% url 'exam_result' examID %}",
                    type: 'GET',
                    success: function (response) {
                        console.log("Modal")
                        $('#resultDiv').html(response);
                        $('#resultInfoModal').modal('show');
                    },
                });
            });

            $(".appealBtn").click(function () {
                let id = $(".question_id_field").val();
                $.ajax({
                    url: `{% url 'appeals' %}${id}/`,
                    type: 'GET',
                    success: function (response) {
                        $('#resultDiv').html(response);
                        $('#appealModal').modal('show');
                    },
                });
            });

            function removeClassCss(cls1, cls2, cls3) {
                $(cls1).removeClass("active");
                $(cls2).removeClass("active");
                $(cls3).removeClass("active");
                $(cls1).css("transform", "");
                $(cls2).css("transform", "");
                $(cls3).css("transform", "");
            }

            $(".Answer").click(function () {
                $(this).addClass("active");
                $(this).css("transform", "scale(1.3)");
                if ($(this).text() === $('#answerA').text()) {
                    removeClassCss('#answerB', '#answerC', '#answerD');
                } else if ($(this).text() === $('#answerB').text()) {
                    removeClassCss('#answerA', '#answerC', '#answerD');
                } else if ($(this).text() === $('#answerC').text()) {
                    removeClassCss('#answerB', '#answerA', '#answerD');
                } else if ($(this).text() === $('#answerD').text()) {
                    removeClassCss('#answerB', '#answerC', '#answerA');
                }
            });

            function timerClock() {
                let x = setInterval(function () {
                    $.ajax({
                        url: '{% url 'timer_view' examID %}',
                        type: 'GET',
                        dataType: 'json',
                        success: function (response) {
                            if (response['is_finish'] === false) {
                                let countDownDate = new Date(response['finish_time']).getTime();
                                let now = new Date(response['current_time']).getTime();
                                let distance = countDownDate - now;

                                let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                let seconds = Math.floor((distance % (1000 * 60)) / 1000);

                                document.getElementById("demo").innerHTML = hours + " : "
                                    + minutes + " : <text style='color:red;'>" + seconds + "</text>";

                                if (distance < 0) {
                                    clearInterval(x);
                                    document.getElementById("demo").innerHTML = "";
                                    $.ajax({
                                        url: "{% url 'exam_finished' examID %}",
                                        type: 'GET',
                                        dataType: 'json',
                                        success: function (response) {
                                            window.location.reload();
                                        },
                                    });
                                }
                            }
                        },
                    });

                }, 3000);
            }

            {% if not is_finished %}
            	timerClock();
            {% endif %}

            $('body').on('click', '.paginationBtn', function (e) {
                e.preventDefault();
                let id = $(this).data('id');
                let url = "{% url 'load_questions' %}" + id + "/";
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        $('.question_id_field').val(response['id']);
                        $('.questionNumber').text(`Savol: ${response['question_order']}`);

                        if (response['is_solved']) {
                            $(response['res1']).addClass("active");
                            $(response['res2']).click();
                            $(response['res1']).css("transform", "scale(1.3)");
                        }


                        let random = Math.floor(Math.random() * 10000001);
                        let url = `${response['pdf_url']}?r` + random + 'm';
                        loadPdf(url);
                    },
                });
            });

            $('body').on('click', '#finishBtn', function (e) {
                e.preventDefault();

                $.ajax({
                    url: "{% url 'exam_finish_btn' examID %}",
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        console.log("FinishBtn")
                        window.location.reload();
                    },
                });
            })

            $.ajax({
                url: '{% url 'load_questions' %}',
                type: 'GET',
                data: {
                    "examID": '{{ examID }}'
                },
                dataType: 'json',
                success: function (response) {
                    $('#questionBtnUl').empty();

                    if (response['is_finished'] === false) {
                        let questions = response['questions'];
                        for (let question of questions) {
                            let button;
                            if (question['is_solved']) {
                                button = `<button type="button" class="btn btn-md paginationBtn is-active forshadow" id="pBtn${question['id']}" data-id="${question['id']}"><li>${question['order_q']}</li></button>`;
                            } else {
                                button = `<button type="button" class="btn btn-md paginationBtn forshadow" id="pBtn${question['id']}" data-id="${question['id']}"><li>${question['order_q']}</li></button>`;
                            }
                            $('#questionBtnUl').append(button);
                        }

                        let url = "{% url 'load_questions' %}" + response['question_id'] + "/";
                        $.ajax({
                            url: url,
                            type: 'GET',
                            dataType: 'json',
                            success: function (response) {
                                console.log(response);
                                $('.questionNumber').text(`Savol: ${response['question_order']}`);
                                $('.question_id_field').val(response['id']);

                                if (response['is_solved']) {
                                    $(response['res1']).addClass("active");
                                    $(response['res2']).click();
                                    $(response['res1']).css("transform", "scale(1.3)");
                                }

                                let random = Math.floor(Math.random() * 10000001);
                                let url = `${response['pdf_url']}?r` + random + 'm';
                                loadPdf(url);
                            },
                        });
                    }else {
                        $.ajax({
                            url: "{% url 'delete_cookie_view' %}",
                            type: 'GET',
                            dataType: 'json',
                            success: function (response) {
                                console.log("Cookie omadli o'chirildi");
                            },
                        });
                    }
                },
            });
        });

        $('body').on('submit', '#nextQuestionForm', function (e) {
            e.preventDefault();
            let url = $('#nextQuestionForm').data('url');

            $.ajax({
                url: url,
                type: 'POST',
                data: $('#nextQuestionForm').serialize(),
                success: function (response) {
                    if (response['result'] === 1) {
                        $(`#pBtn` + response['last_id']).addClass("is-active");
                        $('#nextQuestionForm').trigger("reset");
                        $('#answerA').removeClass("active");
                        $('#answerB').removeClass("active");
                        $('#answerC').removeClass("active");
                        $('#answerD').removeClass("active");
                        $('#answerA').css("transform", "");
                        $('#answerB').css("transform", "");
                        $('#answerC').css("transform", "");
                        $('#answerD').css("transform", "");

                        if (response['is_solved']) {
                            $(response['res1']).addClass("active");
                            $(response['res2']).click();
                            $(response['res1']).css("transform", "scale(1.3)");
                        }

                        $.ajax({
                            url: "{% url 'set_cookie_view' %}",
                            type: 'GET',
                            data: {
                                "question_id": response['id']
                            },
                            success: function (response) {
                                console.log("Ma'lumot Cookiega yozildi.")
                            },
                        });

                        if (response['is_last_question']) {
                            $('.nextQuestionBtn').css("display", "none");
                        }
                        $('.question_id_field').val(response['id']);
                        $('.questionNumber').text(`Savol: ${response['question_order']}`);
                        let random = Math.floor(Math.random() * 10000001);
                        let url = `${response['pdf_url']}?r` + random + 'm';
                        loadPdf(url);
                    } else if (response['result'] === 0) {
                        alert(response['message']);
                    } else if (response['result'] === 2) {
                        $(`#pBtn` + response['last_id']).addClass("is-active");
                    }
                },
            });
        });

        function loadPdf(url) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'pdf_viewer/pdf/pdf.worker.js' %}";
            let PDFRenderingInProgress = false;
            let pdfDoc = null;
            let canvas = document.getElementById('pdf-example');
            let ctx = canvas.getContext('2d');
            let wheelTimeoutHandler = null;
            let wheelTimeout = 250;

            function renderPage(scale) {
                pdfDoc.getPage(1).then(function (page) {
                    let viewport = page.getViewport({scale: scale});
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    let renderContext = {
                        canvasContext: ctx,
                        viewport: viewport,
                    };

                    if (!PDFRenderingInProgress) {
                        PDFRenderingInProgress = true
                        let renderTask = page.render(renderContext);
                        renderTask.promise.then(function () {
                            PDFRenderingInProgress = false
                        })
                    }
                });
            }

            pdfjsLib.getDocument(url).promise.then(function (pdfDoc_) {
                pdfDoc = pdfDoc_;
                renderPage(1.5);
            });

        }
    </script>
{% endblock content %}